<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Profile Setup | Disaster Prep Platform
  </title>
  <!-- Brand Typography -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Font Awesome 6 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <!-- SweetAlert2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.min.css" rel="stylesheet"/>
  <!-- Global Theme Styles -->
  <link href="style.css" rel="stylesheet"/>
  <!-- Page Specific CSS -->
  <link href="profile_setup.css" rel="stylesheet"/>
 </head>
 <body>
  <!-- Header (Common Auth & Onboarding Header) -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#0000FF;">
   <div class="container-fluid">
    <button class="btn btn-outline-light d-md-none me-2" data-bs-target="#mobileSidebarAuth" data-bs-toggle="offcanvas" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="./login_page.html">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/brand/80/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68cee9cfd2b8dfc3b739505b/logos/logo_600b3cc6-083e-4e25-928a-3f997e2061d9.png" style="height:28px;"/>
     <span>
      Disaster Prep Platform
     </span>
    </a>
    <div class="ms-auto d-flex align-items-center">
     <div aria-label="Language" class="btn-group me-2" role="group">
      <button class="btn btn-light btn-sm">
       EN
      </button>
      <button class="btn btn-outline-light btn-sm">
       HI
      </button>
     </div>
     <button class="btn btn-link text-white disabled me-2" title="Notifications">
      <i class="fa-solid fa-bell">
      </i>
     </button>
     <button class="btn btn-link text-white disabled me-2" title="Messages">
      <i class="fa-solid fa-envelope">
      </i>
     </button>
     <div class="dropdown">
      <a aria-expanded="false" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" href="#" id="profileMenuAuth">
       <img alt="avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/avatar/28/28';" src="https://via.placeholder.com/28"/>
       <span>
        Guest
       </span>
      </a>
      <ul aria-labelledby="profileMenuAuth" class="dropdown-menu dropdown-menu-end">
       <li>
        <a class="dropdown-item" href="./login_page.html">
         <i class="fa-solid fa-right-to-bracket me-2">
         </i>
         Login
        </a>
       </li>
       <li>
        <a class="dropdown-item" href="./institution_registration.html">
         <i class="fa-solid fa-building-columns me-2">
         </i>
         Register Institution
        </a>
       </li>
      </ul>
     </div>
    </div>
   </div>
  </nav>
  <div class="container-fluid p-0">
   <div class="d-flex align-items-stretch">
    <!-- Sidebar (Common Auth & Onboarding Sidebar) for Profile Setup page -->
    <nav class="sidebar bg-white border-end d-none d-md-block" id="sidebarAuth" style="width:260px;">
     <style>
      #sidebarAuth .list-group-item { border: 0; border-radius: 0; }
          #sidebarAuth .list-group-item:hover { background-color: #f2f6ff; color: #0000FF; }
          #sidebarAuth .list-group-item.active { background-color: #e8f0ff; color: #0000FF; font-weight: 600; border-left: 3px solid #0000FF; }
     </style>
     <div class="p-3 text-center">
      <img alt="Logo" class="img-fluid mb-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logo/120/48';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68cee9cfd2b8dfc3b739505b/logos/logo_600b3cc6-083e-4e25-928a-3f997e2061d9.png" style="max-height:48px;"/>
      <h6 class="text-primary fw-bold mb-0">
       Disaster Prep
      </h6>
      <small class="text-muted">
       Education &amp; Response
      </small>
     </div>
     <div class="px-3">
      <div class="list-group list-group-flush">
       <a class="list-group-item list-group-item-action" href="./login_page.html">
        <i class="fa-solid fa-right-to-bracket me-2">
        </i>
        Login
       </a>
       <a class="list-group-item list-group-item-action" href="./institution_registration.html">
        <i class="fa-solid fa-building-columns me-2">
        </i>
        Register Institution
       </a>
       <a class="list-group-item list-group-item-action active" href="./profile_setup.html">
        <i class="fa-solid fa-user-gear me-2">
        </i>
        Profile Setup
       </a>
       <a class="list-group-item list-group-item-action" href="./terms.html">
        <i class="fa-solid fa-file-contract me-2">
        </i>
        Terms
       </a>
       <a class="list-group-item list-group-item-action" href="./privacy.html">
        <i class="fa-solid fa-shield-halved me-2">
        </i>
        Privacy
       </a>
      </div>
     </div>
    </nav>
    <!-- Mobile Offcanvas Sidebar -->
    <div class="offcanvas offcanvas-start" id="mobileSidebarAuth" tabindex="-1">
     <div class="offcanvas-header">
      <h5 class="offcanvas-title">
       Disaster Prep
      </h5>
      <button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button">
      </button>
     </div>
     <div class="offcanvas-body">
      <a class="d-block mb-3" href="./login_page.html">
       <i class="fa-solid fa-right-to-bracket me-2">
       </i>
       Login
      </a>
      <a class="d-block mb-3" href="./institution_registration.html">
       <i class="fa-solid fa-building-columns me-2">
       </i>
       Register Institution
      </a>
      <a class="d-block mb-3" href="./profile_setup.html">
       <i class="fa-solid fa-user-gear me-2">
       </i>
       Profile Setup
      </a>
      <hr/>
      <a class="d-block mb-2" href="./terms.html">
       Terms
      </a>
      <a class="d-block" href="./privacy.html">
       Privacy
      </a>
     </div>
    </div>
    <!-- Main Content -->
    <main class="flex-grow-1">
     <div class="container py-3 py-md-4">
      <!-- Page Header -->
      <div class="d-flex align-items-center justify-content-between mb-3">
       <div>
        <h1 class="h4 mb-1">
         Profile Setup
        </h1>
        <p class="text-muted mb-0">
         Finish these steps to secure your account and enable safety features.
        </p>
       </div>
       <div class="text-end d-none d-md-block">
        <a aria-disabled="true" class="btn btn-light btn-sm" disabled="" href="./user_dashboard.html" tabindex="-1">
         <i class="fa-solid fa-house me-1">
         </i>
         Dashboard
        </a>
       </div>
      </div>
      <!-- Notification Area -->
      <div class="d-none" id="systemFeedback">
       <div class="alert alert-warning d-flex align-items-center" role="alert">
        <i class="fa-solid fa-circle-exclamation me-2">
        </i>
        <div id="systemFeedbackText">
         System message
        </div>
       </div>
      </div>
      <!-- Wizard Card -->
      <div class="card app-card setup-wizard">
       <div class="card-header">
        <div class="d-flex align-items-center w-100">
         <div class="me-3">
          <span class="badge bg-primary" id="stepBadge">
           Step 1 of 4
          </span>
         </div>
         <div class="flex-grow-1">
          <div class="progress" style="height: 8px;">
           <div aria-valuemax="100" aria-valuemin="0" aria-valuenow="25" class="progress-bar" id="stepProgress" role="progressbar" style="width: 25%;">
           </div>
          </div>
         </div>
        </div>
       </div>
       <div class="card-body">
        <!-- Step Panels -->
        <!-- Step 1: WelcomeHeader -->
        <section class="wizard-step" data-step="1">
         <div class="text-center py-3">
          <h2 class="mb-2">
           Welcome,
           <span id="welcomeName">
            User
           </span>
           !
          </h2>
          <p class="text-muted mx-auto" style="max-width:720px;">
           Before you start, weâ€™ll help you secure your account, add emergency contacts, and grant essential permissions so safety features work reliably.
          </p>
          <div class="row g-3 mt-3 justify-content-center">
           <div class="col-12 col-md-4">
            <div class="metric-card h-100 text-center">
             <div class="mb-1 text-muted text-uppercase small">
              Step 2
             </div>
             <div class="fw-bold">
              Create a secure password
             </div>
            </div>
           </div>
           <div class="col-12 col-md-4">
            <div class="metric-card h-100 text-center">
             <div class="mb-1 text-muted text-uppercase small">
              Step 3
             </div>
             <div class="fw-bold">
              Add emergency contacts
             </div>
            </div>
           </div>
           <div class="col-12 col-md-4">
            <div class="metric-card h-100 text-center">
             <div class="mb-1 text-muted text-uppercase small">
              Step 4
             </div>
             <div class="fw-bold">
              Grant critical permissions
             </div>
            </div>
           </div>
          </div>
         </div>
        </section>
        <!-- Step 2: AccountSecurityStep -->
        <section class="wizard-step d-none" data-step="2">
         <h3 class="h5 mb-3">
          Account Security
         </h3>
         <div class="row g-3">
          <div class="col-12 col-md-6">
           <label class="form-label" for="newPassword">
            New Password
           </label>
           <div class="input-group">
            <input aria-describedby="passwordHelp" class="form-control password-input" id="newPassword" placeholder="Enter new password" required="" type="password"/>
            <span aria-label="Toggle password visibility" class="input-group-text toggle-visibility-icon" data-target="newPassword" role="button">
             <i class="fa-regular fa-eye">
             </i>
            </span>
           </div>
           <div class="form-text" id="passwordHelp">
            Minimum 8 characters, include a number and a special character.
           </div>
          </div>
          <div class="col-12 col-md-6">
           <label class="form-label" for="confirmPassword">
            Confirm Password
           </label>
           <div class="input-group">
            <input class="form-control password-input" id="confirmPassword" placeholder="Re-enter new password" required="" type="password"/>
            <span aria-label="Toggle password visibility" class="input-group-text toggle-visibility-icon" data-target="confirmPassword" role="button">
             <i class="fa-regular fa-eye">
             </i>
            </span>
           </div>
          </div>
         </div>
         <div class="row g-2 mt-3" id="passwordChecklist">
          <div class="col-12 col-md-4">
           <span class="badge w-100 text-start bg-light text-muted border">
            <i class="fa-solid fa-circle-xmark me-2">
            </i>
            At least 8 characters
           </span>
          </div>
          <div class="col-12 col-md-4">
           <span class="badge w-100 text-start bg-light text-muted border">
            <i class="fa-solid fa-circle-xmark me-2">
            </i>
            Contains a number
           </span>
          </div>
          <div class="col-12 col-md-4">
           <span class="badge w-100 text-start bg-light text-muted border">
            <i class="fa-solid fa-circle-xmark me-2">
            </i>
            Contains a special character
           </span>
          </div>
          <div class="col-12">
           <span class="badge w-100 text-start bg-light text-muted border" id="matchBadge">
            <i class="fa-solid fa-circle-xmark me-2">
            </i>
            Passwords match
           </span>
          </div>
         </div>
        </section>
        <!-- Step 3: EmergencyContactsStep -->
        <section class="wizard-step d-none" data-step="3">
         <div class="d-flex align-items-center justify-content-between mb-2">
          <h3 class="h5 mb-0">
           Emergency Contacts
          </h3>
          <small class="text-muted">
           Add up to 3 contacts
          </small>
         </div>
         <div class="contacts-list" id="contactsList">
         </div>
         <div class="d-flex gap-2 mt-3">
          <button class="btn btn-light" id="addContactBtn">
           <i class="fa-solid fa-user-plus me-2">
           </i>
           Add Another Contact
          </button>
         </div>
         <div class="mt-3">
          <div class="alert alert-info d-flex align-items-center" role="alert">
           <i class="fa-solid fa-circle-info me-2">
           </i>
           Contacts will be notified if you trigger an SOS.
          </div>
         </div>
        </section>
        <!-- Step 4: AppPermissionsStep -->
        <section class="wizard-step d-none" data-step="4">
         <h3 class="h5 mb-3">
          App Permissions
         </h3>
         <div class="row g-3">
          <div class="col-12 col-lg-6">
           <div class="card h-100">
            <div class="card-body">
             <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="d-flex align-items-center gap-2">
               <i class="fa-solid fa-location-dot text-primary">
               </i>
               <div class="fw-semibold">
                Location Access
               </div>
              </div>
              <span class="badge bg-secondary" id="locStatus">
               Not granted
              </span>
             </div>
             <p class="text-muted mb-3">
              Required to share your live location with responders when you send an SOS.
             </p>
             <button class="btn btn-primary" id="grantLocationBtn">
              <span class="btn-label">
               <i class="fa-solid fa-location-crosshairs me-2">
               </i>
               Allow Location
              </span>
              <span aria-hidden="true" class="btn-spinner d-none spinner-border spinner-border-sm" role="status">
              </span>
             </button>
            </div>
           </div>
          </div>
          <div class="col-12 col-lg-6">
           <div class="card h-100">
            <div class="card-body">
             <div class="d-flex align-items-center justify-content-between mb-2">
              <div class="d-flex align-items-center gap-2">
               <i class="fa-solid fa-bell text-warning">
               </i>
               <div class="fw-semibold">
                Push Notifications
               </div>
              </div>
              <span class="badge bg-secondary" id="notifStatus">
               Not granted
              </span>
             </div>
             <p class="text-muted mb-3">
              Needed to receive critical alerts and institution-wide broadcasts.
             </p>
             <button class="btn btn-warning text-dark" id="grantNotifBtn">
              <span class="btn-label">
               <i class="fa-solid fa-bell me-2">
               </i>
               Enable Notifications
              </span>
              <span aria-hidden="true" class="btn-spinner d-none spinner-border spinner-border-sm" role="status">
              </span>
             </button>
            </div>
           </div>
          </div>
         </div>
        </section>
       </div>
       <!-- Wizard Navigation Footer -->
       <div class="card-footer d-flex align-items-center justify-content-between">
        <button class="btn btn-light" id="backBtn">
         <i class="fa-solid fa-arrow-left me-2">
         </i>
         Back
        </button>
        <div class="d-flex gap-2">
         <button class="btn btn-primary" id="nextBtn">
          Next
          <i class="fa-solid fa-arrow-right ms-2">
          </i>
         </button>
         <button class="btn btn-success d-none" id="completeBtn">
          <i class="fa-solid fa-circle-check me-2">
          </i>
          Complete Setup
         </button>
        </div>
       </div>
      </div>
      <!-- Helpful links -->
      <div class="mt-3 text-center text-muted small">
       <span>
        Need help? Visit
        <a href="./help.html">
         Help Center
        </a>
        or contact support.
       </span>
      </div>
     </div>
    </main>
   </div>
  </div>
  <!-- Footer (Common Auth & Onboarding Footer) -->
  <footer class="border-top py-3 bg-white">
   <div class="container-fluid d-flex flex-wrap align-items-center justify-content-between">
    <div class="d-flex align-items-center">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/footer/80/20';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68cee9cfd2b8dfc3b739505b/logos/logo_600b3cc6-083e-4e25-928a-3f997e2061d9.png" style="height:20px;"/>
     <span class="text-muted">
      Â© 2025 Disaster Prep
     </span>
    </div>
    <div class="d-flex gap-3">
     <a class="text-muted text-decoration-none" href="./terms.html">
      Terms
     </a>
     <a class="text-muted text-decoration-none" href="./privacy.html">
      Privacy
     </a>
     <a class="text-muted text-decoration-none" href="./help.html">
      Help
     </a>
    </div>
   </div>
  </footer>
  <!-- Templates -->
  <template id="contactRowTemplate">
   <div class="contact-row card border mb-2">
    <div class="card-body">
     <div class="row g-3 align-items-end">
      <div class="col-12 col-md-5">
       <label class="form-label">
        Full Name
       </label>
       <input class="form-control contact-name" placeholder="e.g., Jordan Lee" required="" type="text"/>
      </div>
      <div class="col-12 col-md-5">
       <label class="form-label">
        Mobile Number
       </label>
       <input class="form-control contact-phone" placeholder="e.g., 9876543210" required="" type="tel"/>
       <div class="form-text">
        Include country code if outside your region.
       </div>
      </div>
      <div class="col-12 col-md-2 d-flex gap-2">
       <button class="btn btn-outline-danger w-100 remove-contact-btn">
        <i class="fa-solid fa-trash-can">
        </i>
        <span class="d-none d-md-inline ms-2">
         Remove
        </span>
       </button>
      </div>
     </div>
    </div>
   </div>
  </template>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <!-- SweetAlert2 JS -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.10.7/dist/sweetalert2.all.min.js">
  </script>
  <script>
   // Prefilled user data (mock)
const prefilledUserData = {
    name: 'Alex Johnson'
};

// Wizard State
let currentStep = 1; // 1..4
const totalSteps = 4;
let passwordState = {
    password: '',
    confirm: ''
};
let contacts = []; // { name: '', phone: '' }
let permissions = {
    location: false,
    notifications: false
};

// Elements
const welcomeNameEl = document.getElementById('welcomeName');
const steps = document.querySelectorAll('.wizard-step');
const stepBadge = document.getElementById('stepBadge');
const stepProgress = document.getElementById('stepProgress');
const backBtn = document.getElementById('backBtn');
const nextBtn = document.getElementById('nextBtn');
const completeBtn = document.getElementById('completeBtn');

const newPasswordInput = document.getElementById('newPassword');
const confirmPasswordInput = document.getElementById('confirmPassword');
const checklistContainer = document.getElementById('passwordChecklist');
const matchBadge = document.getElementById('matchBadge');

const contactsList = document.getElementById('contactsList');
const contactRowTemplate = document.getElementById('contactRowTemplate');
const addContactBtn = document.getElementById('addContactBtn');

const grantLocationBtn = document.getElementById('grantLocationBtn');
const grantNotifBtn = document.getElementById('grantNotifBtn');
const locStatus = document.getElementById('locStatus');
const notifStatus = document.getElementById('notifStatus');

// Init
document.addEventListener('DOMContentLoaded', () => {
    // Set welcome name
    welcomeNameEl.textContent = prefilledUserData?.name || 'User';
    // Initialize with one empty contact row for Step 3
    addContactRow();
    updateUI();

    // Password real-time validation
    newPasswordInput.addEventListener('input', () => {
        passwordState.password = newPasswordInput.value;
        validatePasswordUI();
        updateUI();
    });
    confirmPasswordInput.addEventListener('input', () => {
        passwordState.confirm = confirmPasswordInput.value;
        validatePasswordUI();
        updateUI();
    });

    // Toggle password visibility
    document.querySelectorAll('.toggle-visibility-icon').forEach(el => {
        el.addEventListener('click', () => {
            const id = el.getAttribute('data-target');
            const input = document.getElementById(id);
            if (!input) return;
            const isPassword = input.getAttribute('type') === 'password';
            input.setAttribute('type', isPassword ? 'text' : 'password');
            el.innerHTML = isPassword ? '<i class="fa-regular fa-eye-slash"></i>' : '<i class="fa-regular fa-eye"></i>';
        });
    });

    // Contacts interactivity
    addContactBtn.addEventListener('click', () => {
        if (contacts.length >= 3) return;
        addContactRow();
        updateUI();
    });

    // Permission actions
    grantLocationBtn.addEventListener('click', async () => {
        const spinner = grantLocationBtn.querySelector('.btn-spinner');
        const label = grantLocationBtn.querySelector('.btn-label');
        spinner.classList.remove('d-none');
        label.classList.add('d-none');
        try {
            if ('geolocation' in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        permissions.location = true;
                        Swal.fire({
                            icon: 'success',
                            title: 'Location enabled',
                            timer: 1400,
                            showConfirmButton: false
                        });
                        updateUI();
                    },
                    (err) => {
                        Swal.fire({
                            icon: 'error',
                            title: 'Location denied',
                            text: err.message || 'Unable to obtain location.'
                        });
                        updateUI();
                    }
                );
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Not supported',
                    text: 'Geolocation is not supported in this browser.'
                });
            }
        } finally {
            spinner.classList.add('d-none');
            label.classList.remove('d-none');
        }
    });

    grantNotifBtn.addEventListener('click', async () => {
        const spinner = grantNotifBtn.querySelector('.btn-spinner');
        const label = grantNotifBtn.querySelector('.btn-label');
        spinner.classList.remove('d-none');
        label.classList.add('d-none');
        try {
            if ('Notification' in window) {
                const perm = await Notification.requestPermission();
                if (perm === 'granted') {
                    permissions.notifications = true;
                    Swal.fire({
                        icon: 'success',
                        title: 'Notifications enabled',
                        timer: 1400,
                        showConfirmButton: false
                    });
                } else if (perm === 'denied') {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Notifications denied',
                        text: 'You can enable this later in your browser settings.'
                    });
                } else {
                    Swal.fire({
                        icon: 'info',
                        title: 'Notifications dismissed'
                    });
                }
                updateUI();
            } else {
                Swal.fire({
                    icon: 'info',
                    title: 'Not supported',
                    text: 'Notifications are not supported in this browser.'
                });
            }
        } finally {
            spinner.classList.add('d-none');
            label.classList.remove('d-none');
        }
    });

    // Navigation
    backBtn.addEventListener('click', () => {
        if (currentStep > 1) currentStep--;
        updateUI(true);
    });

    nextBtn.addEventListener('click', () => {
        if (currentStep < totalSteps) currentStep++;
        updateUI(true);
    });

    completeBtn.addEventListener('click', () => {
        if (!canComplete()) return;
        // Simulate save
        Swal.fire({
            icon: 'success',
            title: 'Setup Complete',
            text: 'Your profile is ready. Redirecting to dashboard...',
            timer: 1600,
            showConfirmButton: false
        });
        setTimeout(() => {
            window.location.href = './user_dashboard.html';
        }, 1600);
    });
});

// Helpers
function updateUI(animate = false) {
    // Step panels
    steps.forEach(s => {
        const stepNo = Number(s.getAttribute('data-step'));
        s.classList.toggle('d-none', stepNo !== currentStep);
    });

    // Step badge & progress
    stepBadge.textContent = `Step ${currentStep} of ${totalSteps}`;
    const percent = (currentStep / totalSteps) * 100;
    stepProgress.style.width = `${percent}%`;
    stepProgress.setAttribute('aria-valuenow', String(percent));
    if (animate) {
        stepProgress.classList.add('progress-animate');
        setTimeout(() => stepProgress.classList.remove('progress-animate'), 300);
    }

    // Nav buttons
    backBtn.disabled = currentStep === 1;
    nextBtn.classList.toggle('d-none', currentStep === totalSteps);
    nextBtn.disabled = !isStepValid(currentStep);

    completeBtn.classList.toggle('d-none', currentStep !== totalSteps);
    completeBtn.disabled = !canComplete();

    // Contacts button state
    addContactBtn.disabled = contacts.length >= 3;

    // Permission statuses
    if (permissions.location) {
        locStatus.className = 'badge bg-success';
        locStatus.textContent = 'Granted';
        grantLocationBtn.disabled = true;
    } else {
        locStatus.className = 'badge bg-secondary';
        locStatus.textContent = 'Not granted';
        grantLocationBtn.disabled = false;
    }
    if (permissions.notifications) {
        notifStatus.className = 'badge bg-success';
        notifStatus.textContent = 'Granted';
        grantNotifBtn.disabled = true;
    } else {
        notifStatus.className = 'badge bg-secondary';
        notifStatus.textContent = 'Not granted';
        grantNotifBtn.disabled = false;
    }
}

function isStepValid(step) {
    switch (step) {
        case 1:
            return true; // Welcome step
        case 2:
            return validatePassword();
        case 3:
            return validateContacts();
        case 4:
            return true; // Final step validity handled by canComplete
        default:
            return false;
    }
}

function canComplete() {
    return validatePassword() && validateContacts() && permissions.location && permissions.notifications;
}

function validatePassword() {
    const pwd = passwordState.password || '';
    const conf = passwordState.confirm || '';
    const checks = {
        len: pwd.length >= 8,
        num: /\d/.test(pwd),
        special: /[^A-Za-z0-9]/.test(pwd),
        match: pwd.length > 0 && pwd === conf
    };
    // Update badges UI (if called outside input events)
    renderChecklist(checks);
    return checks.len && checks.num && checks.special && checks.match;
}

function validatePasswordUI() {
    validatePassword();
}

function renderChecklist(checks) {
    const items = checklistContainer.querySelectorAll('.badge');
    // 0: len, 1: num, 2: special, 3: match
    const mapping = [checks.len, checks.num, checks.special, checks.match];
    items.forEach((el, idx) => {
        const passed = mapping[idx];
        el.className = 'badge w-100 text-start border ' + (passed ? 'bg-success text-white' : 'bg-light text-muted');
        const icon = el.querySelector('i');
        if (icon) icon.className = passed ? 'fa-solid fa-circle-check me-2' : 'fa-solid fa-circle-xmark me-2';
    });
}

function addContactRow() {
    if (contacts.length >= 3) return;
    const frag = contactRowTemplate.content.cloneNode(true);
    const row = frag.querySelector('.contact-row');
    const nameInput = frag.querySelector('.contact-name');
    const phoneInput = frag.querySelector('.contact-phone');
    const removeBtn = frag.querySelector('.remove-contact-btn');

    const contact = {
        name: '',
        phone: ''
    };
    contacts.push(contact);

    nameInput.addEventListener('input', (e) => {
        contact.name = e.target.value.trim();
        updateUI();
    });
    phoneInput.addEventListener('input', (e) => {
        contact.phone = e.target.value.trim();
        updateUI();
    });
    removeBtn.addEventListener('click', () => {
        const idx = Array.from(contactsList.children).indexOf(row);
        if (idx > -1) {
            contacts.splice(idx, 1);
        }
        row.remove();
        updateUI();
    });

    contactsList.appendChild(frag);
}

function validateContacts() {
    if (contacts.length === 0) return false;
    // Validate DOM inputs to ensure synced
    const rows = contactsList.querySelectorAll('.contact-row');
    let validRows = 0;
    rows.forEach(row => {
        const name = row.querySelector('.contact-name').value.trim();
        const phone = row.querySelector('.contact-phone').value.trim();
        const nameValid = name.length > 0;
        const phoneValid = /^[0-9]{10,15}$/.test(phone.replace(/\D/g, ''));
        toggleValidity(row.querySelector('.contact-name'), nameValid);
        toggleValidity(row.querySelector('.contact-phone'), phoneValid);
        if (nameValid && phoneValid) validRows++;
    });
    return validRows >= 1; // At least one valid contact required
}

function toggleValidity(inputEl, isValid) {
    inputEl.classList.toggle('is-valid', isValid);
    inputEl.classList.toggle('is-invalid', !isValid && inputEl.value.trim().length > 0);
}
  </script>
 </body>
</html>
