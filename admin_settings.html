<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1" name="viewport"/>
  <title>
   Institution Settings | Admin Console
  </title>
  <!-- Brand Typography: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@100;300;400;500;600;700&amp;display=swap" rel="stylesheet"/>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
   <!-- Font Awesome 6 -->
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>
   <!-- Global Theme Styles -->
   <link href="style.css" rel="stylesheet"/>
   <!-- Page-specific CSS -->
   <link href="admin_settings.css" rel="stylesheet"/>
  </link>
 </head>
 <body>
  <!-- Administrator Management Header (Common Component) -->
  <nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#0000FF;">
   <div class="container-fluid">
    <button class="btn btn-outline-light d-md-none me-2" data-bs-target="#mobileSidebarAdmin" data-bs-toggle="offcanvas" type="button">
     <i class="fa-solid fa-bars">
     </i>
    </button>
    <a class="navbar-brand d-flex align-items-center" href="/admin_dashboard">
     <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/adminlogo/120/28';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68cee9cfd2b8dfc3b739505b/logos/logo_600b3cc6-083e-4e25-928a-3f997e2061d9.png" style="height:28px;"/>
     <span>
      Admin Console
     </span>
    </a>
    <form class="d-none d-md-flex ms-3 flex-grow-1" role="search">
     <div class="input-group">
      <span class="input-group-text bg-white">
       <i class="fa-solid fa-search text-muted">
       </i>
      </span>
      <input aria-label="Search" class="form-control" placeholder="Search users, alerts, settings..." type="search"/>
     </div>
    </form>
    <div class="ms-auto d-flex align-items-center">
     <a class="btn btn-light btn-sm me-2" href="/broadcast_tool">
      <i class="fa-solid fa-bullhorn me-1">
      </i>
      New Broadcast
     </a>
     <a class="btn btn-outline-light btn-sm me-2" href="/user_management#add">
      <i class="fa-solid fa-user-plus me-1">
      </i>
      Add Users
     </a>
     <button class="btn btn-link text-white me-2" title="Notifications">
      <i class="fa-solid fa-bell">
      </i>
     </button>
     <button class="btn btn-link text-white me-2" title="Messages">
      <i class="fa-solid fa-envelope">
      </i>
     </button>
     <div class="dropdown">
      <a aria-expanded="false" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" href="#" id="profileMenuAdmin">
       <img alt="avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/adminavatar/28/28';" src="https://via.placeholder.com/28"/>
       <span>
        {{userName}}
       </span>
      </a>
      <ul aria-labelledby="profileMenuAdmin" class="dropdown-menu dropdown-menu-end">
       <li>
        <h6 class="dropdown-header">
         Administrator
        </h6>
       </li>
       <li>
        <a class="dropdown-item" href="/admin_settings">
         <i class="fa-solid fa-screwdriver-wrench me-2">
         </i>
         Settings
        </a>
       </li>
       <li>
        <hr class="dropdown-divider"/>
       </li>
       <li>
        <a class="dropdown-item" href="/logout">
         <i class="fa-solid fa-right-from-bracket me-2">
         </i>
         Logout
        </a>
       </li>
      </ul>
     </div>
    </div>
   </div>
  </nav>
  <div class="d-flex">
   <!-- Administrator Management Sidebar (Common Component) -->
   <nav class="sidebar bg-white border-end d-none d-md-block" id="sidebarAdmin" style="width:260px;">
    <style>
     #sidebarAdmin .list-group-item { border: 0; border-radius: 0; }
        #sidebarAdmin .list-group-item:hover { background-color: #f2f6ff; color: #0000FF; }
        #sidebarAdmin .list-group-item.active { background-color: #e8f0ff; color: #0000FF; font-weight: 600; border-left: 3px solid #0000FF; }
        #sidebarAdmin .profile-box { background:#f8f9ff; border:1px solid #e8eafc; }
    </style>
    <div class="p-3 text-center border-bottom">
     <img alt="Logo" class="img-fluid" onerror="this.onerror=null;this.src='https://picsum.photos/seed/logofallback/140/38';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68cee9cfd2b8dfc3b739505b/logos/logo_600b3cc6-083e-4e25-928a-3f997e2061d9.png" style="max-height:38px;"/>
    </div>
    <div class="p-3">
     <div class="profile-box rounded p-3 mb-3">
      <div class="d-flex align-items-center">
       <img alt="avatar" class="rounded-circle me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/profile/40/40';" src="https://via.placeholder.com/40"/>
       <div>
        <div class="fw-semibold">
         {{userName}}
        </div>
        <small class="text-muted">
         Administrator
        </small>
       </div>
      </div>
     </div>
     <div class="list-group list-group-flush">
      <a class="list-group-item list-group-item-action" href="/admin_dashboard">
       <i class="fa-solid fa-gauge me-2">
       </i>
       Admin Dashboard
      </a>
      <a class="list-group-item list-group-item-action" href="/user_management">
       <i class="fa-solid fa-users me-2">
       </i>
       User Management
      </a>
      <a class="list-group-item list-group-item-action" href="/broadcast_tool">
       <i class="fa-solid fa-bullhorn me-2">
       </i>
       Broadcast Tool
      </a>
      <a aria-controls="adminSettingsCollapse" aria-expanded="true" class="list-group-item list-group-item-action" data-bs-toggle="collapse" href="#adminSettingsCollapse" role="button">
       <i class="fa-solid fa-screwdriver-wrench me-2">
       </i>
       Settings
      </a>
      <div class="collapse show ps-3" id="adminSettingsCollapse">
       <a class="list-group-item list-group-item-action active" href="/admin_settings">
        <i class="fa-solid fa-shield me-2">
        </i>
        Institution Settings
       </a>
       <a class="list-group-item list-group-item-action" href="/emergency_dashboard">
        <i class="fa-solid fa-signal me-2">
        </i>
        Emergency Dashboard
       </a>
      </div>
     </div>
    </div>
   </nav>
   <!-- Mobile Offcanvas Sidebar (Common Component) -->
   <div class="offcanvas offcanvas-start" id="mobileSidebarAdmin" tabindex="-1">
    <div class="offcanvas-header">
     <h5 class="offcanvas-title">
      Admin Menu
     </h5>
     <button aria-label="Close" class="btn-close" data-bs-dismiss="offcanvas" type="button">
     </button>
    </div>
    <div class="offcanvas-body">
     <a class="d-block mb-3" href="/admin_dashboard">
      <i class="fa-solid fa-gauge me-2">
      </i>
      Admin Dashboard
     </a>
     <a class="d-block mb-3" href="/user_management">
      <i class="fa-solid fa-users me-2">
      </i>
      User Management
     </a>
     <a class="d-block mb-3" href="/broadcast_tool">
      <i class="fa-solid fa-bullhorn me-2">
      </i>
      Broadcast Tool
     </a>
     <a class="d-block mb-3" href="/admin_settings">
      <i class="fa-solid fa-screwdriver-wrench me-2">
      </i>
      Institution Settings
     </a>
     <a class="d-block" href="/emergency_dashboard">
      <i class="fa-solid fa-signal me-2">
      </i>
      Emergency Dashboard
     </a>
    </div>
   </div>
   <!-- Main Content -->
   <main class="flex-grow-1">
    <div class="container-fluid py-3 py-lg-4">
     <!-- Breadcrumb / Page Header -->
     <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
       <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-1">
         <li class="breadcrumb-item">
          <a href="/admin_dashboard">
           <i class="fa-solid fa-gauge">
           </i>
           Admin
          </a>
         </li>
         <li aria-current="page" class="breadcrumb-item active">
          Institution Settings
         </li>
        </ol>
       </nav>
       <h1 class="page-title mb-0">
        Institution Settings
       </h1>
      </div>
      <div class="text-end">
       <button class="btn btn-light" id="btnHelp">
        <i class="fa-regular fa-circle-question me-1">
        </i>
        Help
       </button>
      </div>
     </div>
     <!-- System Feedback / Notification Area -->
     <div class="mb-3" id="systemAlerts">
      <div class="alert alert-info alert-dismissible fade show" role="alert">
       <i class="fa-solid fa-circle-info me-1">
       </i>
       Review your SOS recipients regularly to ensure accuracy.
       <button aria-label="Close" class="btn-close" data-bs-dismiss="alert" type="button">
       </button>
      </div>
     </div>
     <!-- Tabs -->
     <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
      <li class="nav-item" role="presentation">
       <button aria-controls="sosPanel" aria-selected="true" class="nav-link active" data-bs-target="#sosPanel" data-bs-toggle="tab" id="sos-tab" role="tab" type="button">
        <i class="fa-solid fa-bell me-1">
        </i>
        SOS Recipients
       </button>
      </li>
      <li class="nav-item" role="presentation">
       <button aria-controls="infoPanel" aria-selected="false" class="nav-link" data-bs-target="#infoPanel" data-bs-toggle="tab" id="info-tab" role="tab" type="button">
        <i class="fa-solid fa-school me-1">
        </i>
        Institution Info
       </button>
      </li>
      <li class="nav-item" role="presentation">
       <button aria-controls="accountPanel" aria-selected="false" class="nav-link" data-bs-target="#accountPanel" data-bs-toggle="tab" id="account-tab" role="tab" type="button">
        <i class="fa-solid fa-user-lock me-1">
        </i>
        My Account
       </button>
      </li>
     </ul>
     <div class="tab-content pt-3" id="settingsTabsContent">
      <!-- SOS Recipient Manager -->
      <div aria-labelledby="sos-tab" class="tab-pane fade show active" id="sosPanel" role="tabpanel">
       <div class="row g-3">
        <div class="col-12 col-lg-8">
         <div class="card app-card">
          <div class="card-header">
           <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-bell text-primary">
            </i>
            <span class="widget-title">
             SOS Alert Recipients
            </span>
            <span class="badge-soft info ms-2" id="recipientCountBadge">
             0 Active
            </span>
           </div>
           <div class="d-flex align-items-center gap-2">
            <button class="btn btn-light btn-sm" id="btnExportRecipients">
             <i class="fa-solid fa-file-export me-1">
             </i>
             Export
            </button>
            <button class="btn btn-primary btn-sm" data-bs-target="#addRecipientModal" data-bs-toggle="modal" id="btnOpenAddRecipient">
             <i class="fa-solid fa-user-plus me-1">
             </i>
             Add Recipient
            </button>
           </div>
          </div>
          <div class="card-body">
           <!-- Filters -->
           <div class="row g-2 align-items-center mb-3">
            <div class="col-12 col-md-6">
             <div class="input-group">
              <span class="input-group-text">
               <i class="fa-solid fa-filter">
               </i>
              </span>
              <input class="form-control" id="recipientSearch" placeholder="Filter by name or role..." type="text">
              </input>
             </div>
            </div>
            <div class="col-6 col-md-3">
             <select class="form-select" id="roleFilter">
              <option value="">
               All Roles
              </option>
              <option>
               Principal
              </option>
              <option>
               Vice Principal
              </option>
              <option>
               Security
              </option>
              <option>
               Safety Officer
              </option>
              <option>
               Counselor
              </option>
             </select>
            </div>
            <div class="col-6 col-md-3 text-md-end">
             <div aria-label="Sort" class="btn-group" role="group">
              <button class="btn btn-light btn-sm" id="sortByName">
               <i class="fa-solid fa-arrow-up-a-z me-1">
               </i>
               Name
              </button>
              <button class="btn btn-light btn-sm" id="sortByRole">
               <i class="fa-solid fa-layer-group me-1">
               </i>
               Role
              </button>
             </div>
            </div>
           </div>
           <!-- Table -->
           <div class="table-responsive">
            <table class="table table-theme align-middle" id="recipientTable">
             <thead>
              <tr>
               <th>
                Name
               </th>
               <th>
                Role
               </th>
               <th class="text-end">
                Action
               </th>
              </tr>
             </thead>
             <tbody id="recipientTbody">
              <!-- Dynamic rows injected via JS; skeleton while loading -->
              <tr class="loading-row">
               <td colspan="3">
                <div class="skeleton" style="height:18px;">
                </div>
               </td>
              </tr>
              <tr class="loading-row">
               <td colspan="3">
                <div class="skeleton" style="height:18px;">
                </div>
               </td>
              </tr>
              <tr class="loading-row">
               <td colspan="3">
                <div class="skeleton" style="height:18px;">
                </div>
               </td>
              </tr>
             </tbody>
            </table>
           </div>
           <!-- Pagination & Info -->
           <div class="d-flex align-items-center justify-content-between mt-2">
            <small class="text-muted" id="paginationInfo">
             Showing 0–0 of 0
            </small>
            <nav>
             <ul class="pagination pagination-sm mb-0" id="recipientPagination">
              <li class="page-item">
               <button class="page-link" id="prevPage">
                Previous
               </button>
              </li>
              <li class="page-item">
               <button class="page-link" id="nextPage">
                Next
               </button>
              </li>
             </ul>
            </nav>
           </div>
          </div>
         </div>
        </div>
        <div class="col-12 col-lg-4">
         <!-- Chart: Recipients by Role -->
         <div class="card app-card h-100">
          <div class="card-header">
           <div class="d-flex align-items-center gap-2">
            <i class="fa-solid fa-chart-pie text-primary">
            </i>
            <span class="widget-title">
             Recipients by Role
            </span>
           </div>
          </div>
          <div class="card-body">
           <canvas aria-label="Recipients by Role" height="200" id="roleChart" role="img">
           </canvas>
           <small class="text-muted d-block mt-2">
            Hover to see counts. Chart updates as you add/remove recipients.
           </small>
          </div>
         </div>
        </div>
       </div>
      </div>
      <!-- Institution Info Editor -->
      <div aria-labelledby="info-tab" class="tab-pane fade" id="infoPanel" role="tabpanel">
       <div class="card app-card">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-school-flag text-primary">
          </i>
          <span class="widget-title">
           Institution Information
          </span>
         </div>
        </div>
        <div class="card-body">
         <form id="institutionInfoForm" novalidate="">
          <div class="row g-3">
           <div class="col-12 col-lg-6">
            <label class="form-label" for="institutionName">
             Institution Name
            </label>
            <input class="form-control" id="institutionName" required="" type="text"/>
            <div class="invalid-feedback">
             Institution name is required.
            </div>
           </div>
           <div class="col-12">
            <label class="form-label" for="institutionAddress">
             Institution Address
            </label>
            <textarea class="form-control" id="institutionAddress" required="" rows="3"></textarea>
            <div class="invalid-feedback">
             Address is required.
            </div>
           </div>
           <div class="col-12 col-lg-4">
            <label class="form-label" for="primaryContact">
             Primary Contact Number
            </label>
            <input class="form-control" id="primaryContact" placeholder="e.g., (555) 123-4567" required="" type="tel"/>
            <div class="invalid-feedback">
             Enter a valid phone number.
            </div>
           </div>
          </div>
          <div class="d-flex align-items-center justify-content-between mt-3">
           <small class="text-muted" id="infoStatus">
            All changes saved.
           </small>
           <button class="btn btn-primary" disabled="" id="saveInstitutionInfo" type="submit">
            <span class="save-text">
             <i class="fa-solid fa-floppy-disk me-1">
             </i>
             Save Changes
            </span>
            <span class="save-spinner d-none">
             <span aria-hidden="true" class="spinner-border spinner-border-sm me-1" role="status">
             </span>
             Saving...
            </span>
           </button>
          </div>
         </form>
        </div>
       </div>
      </div>
      <!-- Admin Account Manager -->
      <div aria-labelledby="account-tab" class="tab-pane fade" id="accountPanel" role="tabpanel">
       <div class="card app-card">
        <div class="card-header">
         <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-user-shield text-primary">
          </i>
          <span class="widget-title">
           Update Password
          </span>
         </div>
        </div>
        <div class="card-body">
         <form id="passwordChangeForm" novalidate="">
          <div class="row g-3">
           <div class="col-12 col-lg-4">
            <label class="form-label" for="currentPassword">
             Current Password
            </label>
            <div class="input-group">
             <input class="form-control" id="currentPassword" required="" type="password"/>
             <button class="btn btn-light toggle-visibility" data-target="#currentPassword" type="button">
              <i class="fa-regular fa-eye">
              </i>
             </button>
            </div>
            <div class="invalid-feedback">
             Current password is required.
            </div>
           </div>
           <div class="col-12 col-lg-4">
            <label class="form-label" for="newPassword">
             New Password
            </label>
            <div class="input-group">
             <input class="form-control" id="newPassword" required="" type="password"/>
             <button class="btn btn-light toggle-visibility" data-target="#newPassword" type="button">
              <i class="fa-regular fa-eye">
              </i>
             </button>
            </div>
            <small class="text-muted">
             8+ chars, upper/lowercase, number, symbol
            </small>
            <div class="invalid-feedback">
             Password must meet complexity rules.
            </div>
           </div>
           <div class="col-12 col-lg-4">
            <label class="form-label" for="confirmPassword">
             Confirm New Password
            </label>
            <div class="input-group">
             <input class="form-control" id="confirmPassword" required="" type="password"/>
             <button class="btn btn-light toggle-visibility" data-target="#confirmPassword" type="button">
              <i class="fa-regular fa-eye">
              </i>
             </button>
            </div>
            <div class="invalid-feedback">
             Passwords must match.
            </div>
           </div>
          </div>
          <div class="d-flex align-items-center justify-content-between mt-3">
           <small class="text-muted" id="passwordStatus">
            Ensure your password is strong.
           </small>
           <button class="btn btn-primary" disabled="" id="updatePasswordBtn" type="submit">
            <span class="update-text">
             <i class="fa-solid fa-key me-1">
             </i>
             Update Password
            </span>
            <span class="update-spinner d-none">
             <span aria-hidden="true" class="spinner-border spinner-border-sm me-1" role="status">
             </span>
             Updating...
            </span>
           </button>
          </div>
         </form>
        </div>
       </div>
      </div>
     </div>
    </div>
    <!-- Administrator Management Footer (Common Component) -->
    <footer class="border-top py-2 bg-white">
     <div class="container-fluid d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
       <img alt="Logo" class="me-2" onerror="this.onerror=null;this.src='https://picsum.photos/seed/adminfooter/120/18';" src="https://dsaishared.blob.core.windows.net/uxcceleratecontainer/projects/68cee9cfd2b8dfc3b739505b/logos/logo_600b3cc6-083e-4e25-928a-3f997e2061d9.png" style="height:18px;"/>
       <small class="text-muted">
        Admin Console • © 2025
       </small>
      </div>
      <div class="d-flex align-items-center gap-3">
       <a class="text-muted text-decoration-none small" href="/terms">
        Terms
       </a>
       <a class="text-muted text-decoration-none small" href="/privacy">
        Privacy
       </a>
       <a class="text-muted text-decoration-none small" href="/help">
        Help
       </a>
      </div>
     </div>
    </footer>
   </main>
  </div>
  <!-- Add Recipient Modal -->
  <div aria-hidden="true" aria-labelledby="addRecipientModalLabel" class="modal fade" id="addRecipientModal" tabindex="-1">
   <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
     <div class="modal-header">
      <h5 class="modal-title" id="addRecipientModalLabel">
       <i class="fa-solid fa-user-plus me-2">
       </i>
       Add SOS Recipient
      </h5>
      <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button">
      </button>
     </div>
     <div class="modal-body">
      <div class="mb-2">
       <label class="form-label" for="staffSearch">
        Search for staff
       </label>
       <input class="form-control" id="staffSearch" placeholder="Search for staff by name or email..." type="text"/>
       <small class="text-muted">
        Results exclude users already receiving SOS alerts.
       </small>
      </div>
      <div class="text-muted small mb-2" id="searchStatus">
       Type to search...
      </div>
      <ul class="list-group" id="searchResultsList" style="max-height: 300px; overflow:auto;">
       <!-- Dynamic search results -->
      </ul>
     </div>
     <div class="modal-footer">
      <button class="btn btn-light" data-bs-dismiss="modal" type="button">
       Cancel
      </button>
      <button class="btn btn-primary" disabled="" id="confirmAddRecipient" type="button">
       <i class="fa-solid fa-plus me-1">
       </i>
       Add Recipient
      </button>
     </div>
    </div>
   </div>
  </div>
  <!-- Toast Container for system feedback -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1060">
   <div aria-atomic="true" aria-live="assertive" class="toast align-items-center text-bg-primary border-0" id="liveToast" role="alert">
    <div class="d-flex">
     <div class="toast-body" id="toastBody">
      Action completed successfully.
     </div>
     <button aria-label="Close" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" type="button">
     </button>
    </div>
   </div>
  </div>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js">
  </script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js">
  </script>
  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js">
  </script>
  <script>
   // Utility: Toast
function showToast(message, variant = 'primary') {
    const toastEl = document.getElementById('liveToast');
    const body = document.getElementById('toastBody');
    body.textContent = message;
    toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
}

// Mock Data for Recipients
const allRecipients = [{
    id: 'r1',
    name: 'Dr. Alice Nguyen',
    role: 'Principal'
}, {
    id: 'r2',
    name: 'Marcus Lee',
    role: 'Security'
}, {
    id: 'r3',
    name: 'Priya Patel',
    role: 'Vice Principal'
}, {
    id: 'r4',
    name: 'Samuel Ortiz',
    role: 'Safety Officer'
}, {
    id: 'r5',
    name: 'Jin Park',
    role: 'Security'
}, {
    id: 'r6',
    name: 'Evelyn Wright',
    role: 'Counselor'
}, {
    id: 'r7',
    name: 'Karen Smith',
    role: 'Security'
}, {
    id: 'r8',
    name: 'Mohammed Ali',
    role: 'Safety Officer'
}, {
    id: 'r9',
    name: 'Beatrice Gomez',
    role: 'Vice Principal'
}, {
    id: 'r10',
    name: 'Tyler Johnson',
    role: 'Security'
}];

let recipientState = {
    data: [],
    filtered: [],
    currentPage: 1,
    pageSize: 6,
    sortKey: 'name',
    sortAsc: true,
    roleFilter: '',
    search: ''
};

// Chart.js chart instance
let roleChart;

function updateRecipientCountBadge() {
    const badge = document.getElementById('recipientCountBadge');
    badge.textContent = `${recipientState.filtered.length} Active`;
}

function applyFiltersAndSort() {
    const s = recipientState.search.toLowerCase();
    const rf = recipientState.roleFilter;
    let arr = [...recipientState.data];

    // filter search and role
    arr = arr.filter(r => {
        const matchesSearch = r.name.toLowerCase().includes(s) || r.role.toLowerCase().includes(s);
        const matchesRole = rf ? r.role === rf : true;
        return matchesSearch && matchesRole;
    });

    // sort
    const {
        sortKey,
        sortAsc
    } = recipientState;
    arr.sort((a, b) => {
        const va = a[sortKey].toLowerCase();
        const vb = b[sortKey].toLowerCase();
        if (va < vb) return sortAsc ? -1 : 1;
        if (va > vb) return sortAsc ? 1 : -1;
        return 0;
    });

    recipientState.filtered = arr;
    // clamp page
    const maxPage = Math.max(1, Math.ceil(arr.length / recipientState.pageSize));
    if (recipientState.currentPage > maxPage) recipientState.currentPage = maxPage;
    renderRecipientTable();
    renderPaginationInfo();
    updateRecipientCountBadge();
    updateRoleChart();
}

function renderRecipientTable() {
    const tbody = document.getElementById('recipientTbody');
    tbody.innerHTML = '';

    const start = (recipientState.currentPage - 1) * recipientState.pageSize;
    const end = start + recipientState.pageSize;
    const pageItems = recipientState.filtered.slice(start, end);

    if (pageItems.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.innerHTML = '<div class="empty-state">No recipients found.</div>';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    pageItems.forEach(rec => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${rec.name}</td>
          <td>${rec.role}</td>
          <td class="text-end">
            <button class="btn btn-light btn-sm me-2" title="Details" data-id="${rec.id}"><i class="fa-regular fa-id-badge"></i></button>
            <button class="btn btn-danger btn-sm" title="Remove" data-remove-id="${rec.id}"><i class="fa-solid fa-trash"></i></button>
          </td>
        `;
        tbody.appendChild(tr);
    });

    // Attach remove listeners
    tbody.querySelectorAll('button[data-remove-id]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
            const id = e.currentTarget.getAttribute('data-remove-id');
            const rec = recipientState.data.find(r => r.id === id);
            const result = await Swal.fire({
                title: 'Remove recipient?',
                text: `Stop sending SOS alerts to ${rec.name}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Yes, remove',
                cancelButtonText: 'Cancel'
            });
            if (result.isConfirmed) {
                // remove from data
                recipientState.data = recipientState.data.filter(r => r.id !== id);
                applyFiltersAndSort();
                showToast('Recipient removed', 'warning');
            }
        });
    });
}

function renderPaginationInfo() {
    const info = document.getElementById('paginationInfo');
    const total = recipientState.filtered.length;
    if (total === 0) {
        info.textContent = 'Showing 0–0 of 0';
        return;
    }
    const start = (recipientState.currentPage - 1) * recipientState.pageSize + 1;
    const end = Math.min(start + recipientState.pageSize - 1, total);
    info.textContent = `Showing ${start}–${end} of ${total}`;

    // Prev/Next enable
    document.getElementById('prevPage').parentElement.classList.toggle('disabled', recipientState.currentPage === 1);
    const maxPage = Math.ceil(total / recipientState.pageSize);
    document.getElementById('nextPage').parentElement.classList.toggle('disabled', recipientState.currentPage === maxPage);
}

function updateRoleChart() {
    // Aggregate by role
    const counts = {};
    recipientState.data.forEach(r => counts[r.role] = (counts[r.role] || 0) + 1);
    const labels = Object.keys(counts);
    const data = Object.values(counts);

    const colors = [
        'rgba(0,0,255,0.8)', // primary
        'rgba(0,153,210,0.8)', // info
        'rgba(0,119,78,0.8)', // success
        'rgba(255,165,0,0.85)', // warning
        'rgba(205,32,38,0.8)' // error
    ];

    if (!roleChart) {
        roleChart = new Chart(document.getElementById('roleChart'), {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{
                    data,
                    backgroundColor: colors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        enabled: true
                    }
                }
            }
        });
    } else {
        roleChart.data.labels = labels;
        roleChart.data.datasets[0].data = data;
        roleChart.update();
    }
}

// Add Recipient Modal logic
const mockStaffDirectory = [{
    id: 'u101',
    name: 'Olivia Brown',
    email: 'olivia.brown@school.edu',
    role: 'Counselor'
}, {
    id: 'u102',
    name: 'Noah Davis',
    email: 'noah.davis@school.edu',
    role: 'Security'
}, {
    id: 'u103',
    name: 'Emma Wilson',
    email: 'emma.wilson@school.edu',
    role: 'Safety Officer'
}, {
    id: 'u104',
    name: 'Liam Martinez',
    email: 'liam.martinez@school.edu',
    role: 'Vice Principal'
}, {
    id: 'u105',
    name: 'Sophia Anderson',
    email: 'sophia.anderson@school.edu',
    role: 'Principal'
}, {
    id: 'u106',
    name: 'James Thomas',
    email: 'james.thomas@school.edu',
    role: 'Security'
}];
let selectedUser = null;
let searchDebounce;

function alreadyRecipient(user) {
    return recipientState.data.some(r => r.name === user.name);
}

function renderSearchResults(term) {
    const list = document.getElementById('searchResultsList');
    const status = document.getElementById('searchStatus');
    list.innerHTML = '';
    if (!term) {
        status.textContent = 'Type to search...';
        return;
    }
    status.textContent = 'Searching...';
    setTimeout(() => {
        const results = mockStaffDirectory.filter(u =>
            (u.name.toLowerCase().includes(term) || u.email.toLowerCase().includes(term)) && !alreadyRecipient(u)
        );
        status.textContent = `${results.length} result(s)`;
        results.forEach(u => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action d-flex align-items-center justify-content-between';
            li.setAttribute('role', 'button');
            li.innerHTML = `
            <div>
              <div class="fw-semibold">${u.name} <span class="badge bg-light text-dark">${u.role}</span></div>
              <small class="text-muted">${u.email}</small>
            </div>
            <i class="fa-regular fa-circle-check opacity-0"></i>
          `;
            li.addEventListener('click', () => {
                // select
                selectedUser = u;
                // clear previous selection styling
                list.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                li.classList.add('active');
                li.querySelector('i').classList.remove('opacity-0');
                document.getElementById('confirmAddRecipient').disabled = false;
            });
            list.appendChild(li);
        });
    }, 300);
}

function resetAddRecipientModal() {
    selectedUser = null;
    document.getElementById('staffSearch').value = '';
    document.getElementById('confirmAddRecipient').disabled = true;
    document.getElementById('searchResultsList').innerHTML = '';
    document.getElementById('searchStatus').textContent = 'Type to search...';
}

// Institution Info Form Logic
const phoneRegex = /^(\+?\d[\d\s().-]{7,}\d)$/;
const infoInitialData = {
    name: 'Greenfield High School',
    address: '1200 Elm Street, Springfield, CA 90210',
    contact: '(555) 222-8899'
};

function setInfoFormValues(data) {
    document.getElementById('institutionName').value = data.name;
    document.getElementById('institutionAddress').value = data.address;
    document.getElementById('primaryContact').value = data.contact;
}

function validateInfoForm() {
    const nameEl = document.getElementById('institutionName');
    const addrEl = document.getElementById('institutionAddress');
    const phoneEl = document.getElementById('primaryContact');
    const valid = nameEl.value.trim().length > 0 && addrEl.value.trim().length > 0 && phoneRegex.test(phoneEl.value.trim());

    nameEl.classList.toggle('is-invalid', nameEl.value.trim().length === 0);
    addrEl.classList.toggle('is-invalid', addrEl.value.trim().length === 0);
    phoneEl.classList.toggle('is-invalid', !phoneRegex.test(phoneEl.value.trim()));

    return valid;
}

function isInfoFormDirty() {
    return document.getElementById('institutionName').value !== infoInitialData.name ||
        document.getElementById('institutionAddress').value !== infoInitialData.address ||
        document.getElementById('primaryContact').value !== infoInitialData.contact;
}

// Password Form Logic
function checkPasswordComplexity(pwd) {
    // 8+ chars, upper, lower, number, symbol
    return /[A-Z]/.test(pwd) && /[a-z]/.test(pwd) && /\d/.test(pwd) && /[^A-Za-z0-9]/.test(pwd) && pwd.length >= 8;
}

function validatePasswordForm() {
    const cur = document.getElementById('currentPassword');
    const pwd = document.getElementById('newPassword');
    const conf = document.getElementById('confirmPassword');
    const valid = cur.value.length > 0 && checkPasswordComplexity(pwd.value) && conf.value === pwd.value;
    cur.classList.toggle('is-invalid', cur.value.length === 0);
    pwd.classList.toggle('is-invalid', !checkPasswordComplexity(pwd.value));
    conf.classList.toggle('is-invalid', conf.value !== pwd.value || conf.value.length === 0);
    return valid;
}

document.addEventListener('DOMContentLoaded', () => {
    // Initialize recipients (simulate loading)
    setTimeout(() => {
        recipientState.data = allRecipients.slice(0, 9); // initial load
        applyFiltersAndSort();
    }, 600);

    // Pagination buttons
    document.getElementById('prevPage').addEventListener('click', () => {
        if (recipientState.currentPage > 1) {
            recipientState.currentPage--;
            renderRecipientTable();
            renderPaginationInfo();
        }
    });
    document.getElementById('nextPage').addEventListener('click', () => {
        const maxPage = Math.ceil(recipientState.filtered.length / recipientState.pageSize);
        if (recipientState.currentPage < maxPage) {
            recipientState.currentPage++;
            renderRecipientTable();
            renderPaginationInfo();
        }
    });

    // Search and filter
    document.getElementById('recipientSearch').addEventListener('input', (e) => {
        recipientState.search = e.target.value;
        recipientState.currentPage = 1;
        applyFiltersAndSort();
    });
    document.getElementById('roleFilter').addEventListener('change', (e) => {
        recipientState.roleFilter = e.target.value;
        recipientState.currentPage = 1;
        applyFiltersAndSort();
    });

    // Sorting
    document.getElementById('sortByName').addEventListener('click', () => {
        if (recipientState.sortKey === 'name') recipientState.sortAsc = !recipientState.sortAsc;
        else {
            recipientState.sortKey = 'name';
            recipientState.sortAsc = true;
        }
        applyFiltersAndSort();
    });
    document.getElementById('sortByRole').addEventListener('click', () => {
        if (recipientState.sortKey === 'role') recipientState.sortAsc = !recipientState.sortAsc;
        else {
            recipientState.sortKey = 'role';
            recipientState.sortAsc = true;
        }
        applyFiltersAndSort();
    });

    // Export (mock)
    document.getElementById('btnExportRecipients').addEventListener('click', () => {
        Swal.fire({
            title: 'Export Recipients',
            text: 'A CSV file will be prepared for download.',
            icon: 'info',
            confirmButtonText: 'OK'
        });
    });

    // Modal events
    const addModalEl = document.getElementById('addRecipientModal');
    addModalEl.addEventListener('show.bs.modal', resetAddRecipientModal);

    document.getElementById('staffSearch').addEventListener('input', (e) => {
        const term = e.target.value.trim().toLowerCase();
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => renderSearchResults(term), 250);
    });

    document.getElementById('confirmAddRecipient').addEventListener('click', async () => {
        if (!selectedUser) return;
        const result = await Swal.fire({
            title: 'Add recipient?',
            text: `Start sending SOS alerts to ${selectedUser.name}?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, add',
            cancelButtonText: 'Cancel'
        });
        if (result.isConfirmed) {
            // Add to recipients
            recipientState.data.push({
                id: 'r' + Math.random().toString(36).slice(2, 8),
                name: selectedUser.name,
                role: selectedUser.role
            });
            applyFiltersAndSort();
            showToast('Recipient added', 'success');
            const modal = bootstrap.Modal.getInstance(addModalEl);
            modal.hide();
        }
    });

    // Institution Info: load initial
    setInfoFormValues(infoInitialData);
    // Detect changes and validate
    ['institutionName', 'institutionAddress', 'primaryContact'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            const valid = validateInfoForm();
            const dirty = isInfoFormDirty();
            const btn = document.getElementById('saveInstitutionInfo');
            btn.disabled = !(valid && dirty);
            document.getElementById('infoStatus').textContent = dirty ? 'Unsaved changes' : 'All changes saved.';
        });
    });
    // Submit
    document.getElementById('institutionInfoForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validateInfoForm()) return;
        const btn = document.getElementById('saveInstitutionInfo');
        btn.querySelector('.save-text').classList.add('d-none');
        btn.querySelector('.save-spinner').classList.remove('d-none');
        btn.disabled = true;
        await new Promise(r => setTimeout(r, 900));
        // Persist updates to initial data
        infoInitialData.name = document.getElementById('institutionName').value;
        infoInitialData.address = document.getElementById('institutionAddress').value;
        infoInitialData.contact = document.getElementById('primaryContact').value;
        document.getElementById('infoStatus').textContent = 'All changes saved.';
        btn.querySelector('.save-text').classList.remove('d-none');
        btn.querySelector('.save-spinner').classList.add('d-none');
        Swal.fire({
            title: 'Saved',
            text: 'Institution information updated.',
            icon: 'success'
        });
    });

    // Password form interactions
    document.querySelectorAll('.toggle-visibility').forEach(btn => {
        btn.addEventListener('click', () => {
            const targetSel = btn.getAttribute('data-target');
            const input = document.querySelector(targetSel);
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            btn.innerHTML = type === 'password' ? '<i class="fa-regular fa-eye"></i>' : '<i class="fa-regular fa-eye-slash"></i>';
        });
    });
    ['currentPassword', 'newPassword', 'confirmPassword'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            const ok = validatePasswordForm();
            document.getElementById('updatePasswordBtn').disabled = !ok;
            document.getElementById('passwordStatus').textContent = ok ? 'Ready to update password.' : 'Ensure your password meets the requirements.';
        });
    });
    document.getElementById('passwordChangeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!validatePasswordForm()) return;
        const btn = document.getElementById('updatePasswordBtn');
        btn.querySelector('.update-text').classList.add('d-none');
        btn.querySelector('.update-spinner').classList.remove('d-none');
        btn.disabled = true;
        await new Promise(r => setTimeout(r, 900));
        btn.querySelector('.update-text').classList.remove('d-none');
        btn.querySelector('.update-spinner').classList.add('d-none');
        btn.disabled = false;
        document.getElementById('passwordChangeForm').reset();
        document.getElementById('passwordStatus').textContent = 'Password updated successfully.';
        Swal.fire({
            title: 'Success',
            text: 'Your password has been updated.',
            icon: 'success'
        });
    });

    // Help button
    document.getElementById('btnHelp').addEventListener('click', () => {
        Swal.fire({
            title: 'Institution Settings Help',
            html: '<div class="text-start">\
                  <p>• SOS Recipients: Manage who receives emergency alerts.</p>\
                  <p>• Institution Info: Keep your contact details up-to-date.</p>\
                  <p>• My Account: Change your password regularly for security.</p>\
                </div>',
            icon: 'info'
        });
    });
});
  </script>
 </body>
</html>
